Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/jammy64"
  config.vm.provider "virtualbox"

  # Common provisioning for all nodes
  COMMON_PROVISION = <<-SHELL
    set -eux

    # Disable swap (RKE2 requirement)
    swapoff -a
    sed -i '/ swap / s/^/#/' /etc/fstab

    # Kernel modules
    cat <<EOF | tee /etc/modules-load.d/rke2.conf
overlay
br_netfilter
EOF

    modprobe overlay
    modprobe br_netfilter

    # Sysctl settings for Kubernetes
    cat <<EOF | tee /etc/sysctl.d/rke2.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

    sysctl --system

    # Install base packages
    apt-get update
    apt-get install -y \
      curl \
      wget \
      ca-certificates \
      gnupg \
      lsb-release \
      iptables \
      network-manager \
      nfs-common \
      open-iscsi \
      socat \
      conntrack

    systemctl enable --now iscsid
    systemctl enable NetworkManager

    # Ensure NetworkManager ignores CNI interfaces
    mkdir -p /etc/NetworkManager/conf.d
    cat <<EOF | tee /etc/NetworkManager/conf.d/rke2-cni.conf
[keyfile]
unmanaged-devices=interface-name:cni*;interface-name:flannel*;interface-name:calico*
EOF

    systemctl restart NetworkManager

    # Open required RKE2 ports (iptables)
    for port in 6443 9345 10250 2379 2380 2381; do
      iptables -C INPUT -p tcp --dport $port -j ACCEPT 2>/dev/null || \
      iptables -A INPUT -p tcp --dport $port -j ACCEPT
    done

    iptables -C INPUT -p udp --dport 8472 -j ACCEPT 2>/dev/null || \
    iptables -A INPUT -p udp --dport 8472 -j ACCEPT

    iptables-save > /etc/iptables.rules
  SHELL

  # Control Plane
  config.vm.define "control" do |node|
    node.vm.hostname = "rke2-control"
    node.vm.network "private_network", ip: "192.168.56.10"

    node.vm.provider "virtualbox" do |vb|
      vb.name = "rke2-control"
      vb.cpus = 4
      vb.memory = 8192
    end

    node.vm.provision "shell", inline: COMMON_PROVISION
  end

  # Workers removed - Host machine will be used as GPU worker node
  # Host will run RKE2 agent and join this control plane
  # This enables direct GPU access without VirtualBox passthrough limitations
end
